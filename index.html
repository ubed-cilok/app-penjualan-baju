<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Admin Penjualan Halimahid</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="logo.png">

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW Suksés!', reg.scope))
          .catch(err => console.log('SW Gagal:', err));
      });
    }
  </script>

  <style>
    :root { --primary: #6366f1; --bg: #f8fafc; --card: #ffffff; }
    body { background-color: var(--bg); padding-bottom: 90px; font-family: 'Inter', sans-serif; color: #1e293b; }
    .app-header { background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); color: white; padding: 25px 15px; border-radius: 0 0 25px 25px; margin-bottom: 20px; }
    .card { border-radius: 20px; border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 15px; padding: 18px; }
    .form-control, .form-select { border-radius: 12px; border: 1px solid #e2e8f0; padding: 12px; font-size: 14px; }
    .form-control:focus { box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); border-color: var(--primary); }
    .bottom-nav { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 25px; display: flex; padding: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 1000; }
    .nav-item { text-align: center; color: #94a3b8; flex: 1; transition: 0.3s; cursor: pointer; }
    .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }
    .nav-item.active { color: var(--primary); transform: translateY(-5px); }
    .page-section { display: none; padding: 0 15px; animation: fadeIn 0.4s; }
    .page-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .badge-lunas { background-color: #dcfce7; color: #166534; padding: 5px 10px; border-radius: 8px; font-weight: 600; font-size: 11px; }
    .badge-sisa { background-color: #fee2e2; color: #991b1b; padding: 5px 10px; border-radius: 8px; font-weight: 600; font-size: 11px; }
    .btn-primary { background-color: var(--primary); border: none; border-radius: 12px; padding: 12px; font-weight: 600; }
    .filter-box { background: #f1f5f9; border-radius: 15px; padding: 15px; margin-bottom: 15px; }
  </style>
</head>
<body>

  <div class="app-header text-center">
    <h4 class="m-0 fw-bold">Admin Penjualan</h4>
    <p class="small opacity-75 mb-0">Halimah.id</p>
    
    <button id="btnInstall" class="btn btn-sm btn-warning fw-bold mt-2" style="display: none;">
      <i class="fas fa-download"></i> Install Aplikasi
    </button>
  </div>

  <div id="formInput" class="page-section active">
    <div class="card">
      <h6 class="fw-bold mb-4" id="formTitle"><i class="fas fa-plus-circle me-2 text-primary"></i>Transaksi Baru</h6>
      <form id="penjualanForm">
        <input type="hidden" id="idEdit" name="idEdit">
        
        <div class="mb-3">
          <label class="small fw-semibold text-muted">Nama Pembeli</label>
          <input type="text" class="form-control" name="namaPembeli" id="namaPembeli" list="listPembeli" required>
          <datalist id="listPembeli"></datalist>
        </div>
        
        <div class="row">
          <div class="col-6 mb-3"><label class="small fw-semibold text-muted">Tanggal</label><input type="date" class="form-control" name="tanggal" id="tanggal" required></div>
          <div class="col-6 mb-3"><label class="small fw-semibold text-muted">Status</label>
            <select class="form-select" name="status" id="status">
              <option value="Dipesan">Dipesan</option><option value="Proses">Proses</option><option value="Packing">Packing</option><option value="Sedang Dikirim">Sedang Dikirim</option><option value="Selesai">Selesai</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="small fw-semibold text-muted">Produk</label>
          <input type="text" class="form-control" name="namaProduk" id="namaProduk" list="listProduk" required>
          <datalist id="listProduk"></datalist>
        </div>
        
        <div class="row">
          <div class="col-6 mb-3"><label class="small fw-semibold text-muted">Brand</label><input type="text" class="form-control" name="brand" id="brand"></div>
          <div class="col-6 mb-3"><label class="small fw-semibold text-muted">Series</label><input type="text" class="form-control" name="series" id="series"></div>
        </div>
        <div class="row">
          <div class="col-6 mb-3"><label class="small fw-semibold text-muted">Ukuran</label>
            <select class="form-select" name="ukuran" id="ukuran">
              <option>S</option><option>M</option><option>L</option><option>XL</option><option>XXL</option>
            </select>
          </div>
          <div class="col-6 mb-3"><label class="small fw-semibold text-muted">Jenis Order</label><input type="text" class="form-control" name="jenisOrder" id="jenisOrder"></div>
        </div>

        <div class="row bg-light p-2 rounded-3 mb-3 mx-0 border">
          <div class="col-4 px-1"><label class="x-small text-muted fw-bold">Harga</label><input type="text" class="form-control p-2 format-uang" id="harga" name="harga"></div>
          <div class="col-4 px-1"><label class="x-small text-muted fw-bold">DP</label><input type="text" class="form-control p-2 format-uang" id="dp" name="dp"></div>
          <div class="col-4 px-1"><label class="x-small text-muted fw-bold">Cicilan</label><input type="text" class="form-control p-2 format-uang" id="cicilan1" name="cicilan1"></div>
          <div class="col-12 mt-2"><label class="small fw-bold">Sisa Pembayaran: </label> <input type="text" class="form-control bg-white fw-bold text-danger border-danger" id="sisa" name="sisa" readonly></div>
        </div>
        
        <div class="row">
          <div class="col-6 mb-3"><label class="small fw-semibold text-muted">Marketer</label>
            <input type="text" class="form-control" name="marketer" id="marketer" list="listMarketer">
            <datalist id="listMarketer"></datalist>
          </div>
          <div class="col-6 mb-3"><label class="small fw-semibold text-muted">Fee Mktr (Rp)</label><input type="text" class="form-control format-uang" name="feeMarketer" id="feeMarketer"></div>
        </div>
        <div class="mb-3"><label class="small fw-semibold text-muted">Fee Baju/Profit (Rp)</label><input type="text" class="form-control format-uang" name="feeBaju" id="feeBaju"></div>
        
        <button type="button" class="btn btn-primary w-100 shadow-sm" id="btnSimpan" onclick="submitData()">Simpan Data</button>
        <button type="button" class="btn btn-secondary w-100 mt-2 d-none" id="btnBatal" onclick="batalEdit()">Batal Edit</button>
      </form>
    </div>
  </div>

  <div id="halamanData" class="page-section">
    <div class="card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold m-0">Database</h6>
        <div>
          <input type="file" id="fileImport" accept=".xlsx, .xls" style="display: none;">
          <button onclick="document.getElementById('fileImport').click()" class="btn btn-sm btn-info text-white shadow-sm me-1"><i class="fas fa-file-import"></i> Import</button>
          <button onclick="exportToExcel()" class="btn btn-sm btn-success shadow-sm"><i class="fas fa-file-excel"></i> Export</button>
        </div>
      </div>
      
      <div class="filter-box">
        <input type="text" class="form-control mb-2" id="searchNama" placeholder="Cari nama pembeli..." onkeyup="filterTabel()">
        <div class="row g-2">
          <div class="col-4"><input type="text" class="form-control form-control-sm" id="fProduk" placeholder="Produk" onkeyup="filterTabel()"></div>
          <div class="col-4"><input type="text" class="form-control form-control-sm" id="fBrand" placeholder="Brand" onkeyup="filterTabel()"></div>
          <div class="col-4"><input type="text" class="form-control form-control-sm" id="fSeries" placeholder="Series" onkeyup="filterTabel()"></div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle" style="font-size: 11px;">
          <thead class="table-light"><tr><th>Info Transaksi</th><th>Pembayaran</th><th>Aksi</th></tr></thead>
          <tbody id="tabelDataBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="halamanGrafik" class="page-section"><div class="card"><h6 class="fw-bold mb-3">Grafik Produk</h6><canvas id="myChart"></canvas></div></div>
  <div id="halamanFee" class="page-section"><div class="card p-3"><h6 class="fw-bold">Laporan Fee Marketer</h6><div class="table-responsive mt-3"><table class="table table-bordered text-center align-middle" style="font-size:12px;"><thead class="table-light"><tr><th>Marketer</th><th>Total Fee (Rp)</th></tr></thead><tbody id="tabelFeeBody"></tbody><tfoot class="table-secondary fw-bold"><tr><td>Total Keseluruhan</td><td id="grandTotalFee">0</td></tr></tfoot></table></div></div></div>
  
  <div id="halamanPiutang" class="page-section">
    <div class="card p-3">
      <h6 class="fw-bold text-danger mb-3"><i class="fas fa-wallet me-2"></i>Daftar Piutang</h6>
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle text-nowrap" style="font-size:12px;">
          <thead class="table-light">
            <tr><th>Nama</th><th>Produk</th><th>Brand</th><th>Series</th><th>Jenis Orderan</th><th>Size</th><th>Sisa (Rp)</th></tr>
          </thead>
          <tbody id="tabelPiutangBody"></tbody>
          <tfoot class="table-secondary fw-bold">
            <tr>
              <td colspan="6" class="text-end pe-3">Total Piutang Keseluruhan:</td>
              <td class="text-danger" id="grandTotalPiutang">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" id="navInput" onclick="switchTab('formInput', this)"><i class="fas fa-plus-circle"></i><span>Input</span></div>
    <div class="nav-item" onclick="switchTab('halamanData', this); loadAllData();"><i class="fas fa-database"></i><span>Data</span></div>
    <div class="nav-item" onclick="switchTab('halamanGrafik', this); loadChart();"><i class="fas fa-chart-pie"></i><span>Grafik</span></div>
    <div class="nav-item" onclick="switchTab('halamanFee', this); loadFee();"><i class="fas fa-wallet"></i><span>Fee</span></div>
    <div class="nav-item" onclick="switchTab('halamanPiutang', this); loadPiutang();"><i class="fas fa-clock"></i><span>Piutang</span></div>
  </div>

  <script>
    const STORAGE_KEY = 'appPenjualanOfflineData';
    let myChartInstance = null;

    function getLocalData() { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
    function saveLocalData(dataArray) { localStorage.setItem(STORAGE_KEY, JSON.stringify(dataArray)); }
    function cleanNum(val) { if (!val) return 0; return parseInt(val.toString().replace(/\./g, '')) || 0; }

    function formatRupiah(angka) {
      if(!angka) return '';
      let number_string = angka.toString().replace(/[^,\d]/g, ''), split = number_string.split(','), sisa = split[0].length % 3, rupiah = split[0].substr(0, sisa), ribuan = split[0].substr(sisa).match(/\d{3}/gi);
      if(ribuan){ rupiah += (sisa ? '.' : '') + ribuan.join('.'); }
      return rupiah;
    }

    document.querySelectorAll('.format-uang').forEach(input => {
      input.addEventListener('keyup', function() { this.value = formatRupiah(this.value); hitungSisa(); });
    });

    function hitungSisa() {
      let h = cleanNum(document.getElementById('harga').value);
      let d = cleanNum(document.getElementById('dp').value);
      let c = cleanNum(document.getElementById('cicilan1').value);
      document.getElementById('sisa').value = formatRupiah((h - d - c).toString());
    }

    function switchTab(tabId, el) {
      document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      el.classList.add('active');
    }

    function exportToExcel() {
      const data = getLocalData();
      if(data.length === 0) { alert("Data masih kosong!"); return; }
      const excelData = data.map(d => ({
        "ID Transaksi": d.id, "Tanggal": d.tanggal, "Nama Pembeli": d.namaPembeli, "Produk": d.namaProduk, "Brand": d.brand, "Series": d.series, "Ukuran": d.ukuran, "Jenis Orderan": d.jenisOrder, "Harga": d.harga, "DP": d.dp, "Cicilan": d.cicilan1, "Sisa": d.sisa, "Status": d.status, "Marketer": d.marketer, "Fee Marketer": d.feeMarketer, "Fee Baju": d.feeBaju
      }));
      const worksheet = XLSX.utils.json_to_sheet(excelData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Data Penjualan");
      XLSX.writeFile(workbook, `Penjualan_Baju_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    document.getElementById('fileImport').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

          if(jsonData.length === 0) { alert("File Excel kosong atawa formatna beda!"); return; }

          let localData = getLocalData();
          let count = 0;

          jsonData.forEach(row => {
            // Pami file excelna teu nyantumkeun ID, otomatis di-generate ID anyar sangkan teu error
            let autoId = new Date().getTime() + Math.floor(Math.random() * 10000);
            
            let obj = {
              id: row["ID Transaksi"] || row["ID"] || autoId,
              tanggal: row["Tanggal"] || "",
              namaPembeli: row["Nama Pembeli"] || "",
              namaProduk: row["Produk"] || "",
              brand: row["Brand"] || "",
              series: row["Series"] || "",
              ukuran: row["Ukuran"] || row["Size"] || "",
              jenisOrder: row["Jenis Orderan"] || row["Jenis Order"] || "",
              harga: cleanNum(row["Harga"]), dp: cleanNum(row["DP"]), cicilan1: cleanNum(row["Cicilan"]), sisa: cleanNum(row["Sisa"]),
              status: row["Status"] || "Proses Jahit",
              marketer: row["Marketer"] || "",
              feeMarketer: cleanNum(row["Fee Marketer"]), feeBaju: cleanNum(row["Fee Baju"])
            };
            
            let existingIdx = localData.findIndex(d => d.id.toString() === obj.id.toString());
            if(existingIdx > -1) { localData[existingIdx] = obj; } else { localData.push(obj); }
            count++;
          });

          saveLocalData(localData); loadAllData(); loadDropdowns();
          alert(`Suksés import ${count} data!`);
        } catch(error) { alert("Gagal ngabaca file!"); }
        document.getElementById('fileImport').value = ""; 
      };
      reader.readAsArrayBuffer(file);
    });

    function submitData() {
      let form = document.getElementById('penjualanForm');
      let obj = Object.fromEntries(new FormData(form).entries());
      obj.harga = cleanNum(obj.harga); obj.dp = cleanNum(obj.dp); obj.cicilan1 = cleanNum(obj.cicilan1); obj.sisa = cleanNum(obj.sisa); obj.feeMarketer = cleanNum(obj.feeMarketer); obj.feeBaju = cleanNum(obj.feeBaju);

      let data = getLocalData();
      if (obj.idEdit) {
        let index = data.findIndex(d => d.id.toString() === obj.idEdit.toString());
        if(index > -1) data[index] = { ...data[index], ...obj };
        alert("Data berhasil diupdate!");
      } else {
        obj.id = new Date().getTime(); 
        data.push(obj);
        alert("Data berhasil disimpan!");
      }
      saveLocalData(data); batalEdit(); loadDropdowns();
    }

    function loadAllData() { renderTabel(getLocalData().reverse()); }

    function filterTabel() {
      let sNama = document.getElementById('searchNama').value.toLowerCase(); let fP = document.getElementById('fProduk').value.toLowerCase(); let fB = document.getElementById('fBrand').value.toLowerCase(); let fS = document.getElementById('fSeries').value.toLowerCase();
      let data = getLocalData().reverse().filter(item => (item.namaPembeli || '').toLowerCase().includes(sNama) && (item.namaProduk || '').toLowerCase().includes(fP) && (item.brand || '').toLowerCase().includes(fB) && (item.series || '').toLowerCase().includes(fS));
      renderTabel(data);
    }

    function renderTabel(data) {
      const tbody = document.getElementById('tabelDataBody'); tbody.innerHTML = '';
      if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Belum ada data</td></tr>'; return; }
      data.forEach(item => {
        let sisaText = item.sisa <= 0 ? `<span class="badge-lunas">Lunas</span>` : `<span class="badge-sisa">Rp ${item.sisa.toLocaleString('id-ID')}</span>`;
        tbody.innerHTML += `<tr><td><div class="fw-bold text-primary">${item.namaPembeli}</div><div class="text-muted small">${item.tanggal} | ${item.namaProduk}</div><div class="x-small text-uppercase text-secondary">${item.brand} - ${item.series}</div></td><td><div class="mb-1">${sisaText}</div><div class="small text-muted">${item.status}</div></td><td><div class="d-flex gap-1"><button class="btn btn-sm btn-outline-warning border-0" onclick="siapkanEdit('${item.id}')" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger border-0" onclick="hapusData('${item.id}')" title="Hapus"><i class="fas fa-trash-alt"></i></button></div></td></tr>`;
      });
    }

    function hapusData(id) {
      if(confirm("Yakin badé ngahapus data ieu? Data nu tos dihapus moal tiasa balik deui.")) {
        let newData = getLocalData().filter(d => d.id.toString() !== id.toString());
        saveLocalData(newData); loadAllData(); loadDropdowns();
      }
    }

    function siapkanEdit(id) {
      const item = getLocalData().find(x => x.id.toString() === id.toString()); if(!item) return;
      document.getElementById('idEdit').value = item.id; document.getElementById('namaPembeli').value = item.namaPembeli; document.getElementById('tanggal').value = item.tanggal; document.getElementById('status').value = item.status; document.getElementById('namaProduk').value = item.namaProduk; document.getElementById('brand').value = item.brand; document.getElementById('series').value = item.series; document.getElementById('ukuran').value = item.ukuran; document.getElementById('jenisOrder').value = item.jenisOrder; document.getElementById('harga').value = formatRupiah(item.harga); document.getElementById('dp').value = formatRupiah(item.dp); document.getElementById('cicilan1').value = formatRupiah(item.cicilan1); document.getElementById('sisa').value = formatRupiah(item.sisa); document.getElementById('marketer').value = item.marketer; document.getElementById('feeMarketer').value = formatRupiah(item.feeMarketer); document.getElementById('feeBaju').value = formatRupiah(item.feeBaju);
      document.getElementById('formTitle').innerText = "Edit Transaksi"; document.getElementById('btnSimpan').innerText = "Update Data"; document.getElementById('btnBatal').classList.remove('d-none'); switchTab('formInput', document.getElementById('navInput'));
    }

    function batalEdit() { document.getElementById('penjualanForm').reset(); document.getElementById('idEdit').value = ""; document.getElementById('btnBatal').classList.add('d-none'); document.getElementById('formTitle').innerHTML = '<i class="fas fa-plus-circle me-2 text-primary"></i>Transaksi Baru'; document.getElementById('btnSimpan').innerText = "Simpan Data"; }

    function loadDropdowns() {
      let data = getLocalData(); let pembeli = [...new Set(data.map(d => d.namaPembeli).filter(Boolean))]; let produk = [...new Set(data.map(d => d.namaProduk).filter(Boolean))]; let marketer = [...new Set(data.map(d => d.marketer).filter(Boolean))];
      document.getElementById('listPembeli').innerHTML = pembeli.map(x => `<option value="${x}">`).join(''); document.getElementById('listProduk').innerHTML = produk.map(x => `<option value="${x}">`).join(''); document.getElementById('listMarketer').innerHTML = marketer.map(x => `<option value="${x}">`).join('');
    }

    function loadChart() {
      let counts = {}; getLocalData().forEach(d => { if(d.namaProduk) counts[d.namaProduk] = (counts[d.namaProduk] || 0) + 1; });
      const ctx = document.getElementById('myChart'); if(myChartInstance) myChartInstance.destroy();
      myChartInstance = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(counts), datasets: [{ label: 'Jumlah Terjual', data: Object.values(counts), backgroundColor: '#6366f1' }] } });
    }

    function loadFee() {
      let fees = {}; let total = 0; getLocalData().forEach(d => { if(d.marketer) { let f = parseFloat(d.feeMarketer) || 0; fees[d.marketer] = (fees[d.marketer] || 0) + f; total += f; } });
      let tb = document.getElementById('tabelFeeBody'); tb.innerHTML = '';
      if(Object.keys(fees).length === 0) tb.innerHTML = '<tr><td colspan="2" class="text-muted">Belum ada data</td></tr>';
      for(let m in fees) { tb.innerHTML += `<tr><td class="fw-bold">${m}</td><td>${fees[m].toLocaleString('id-ID')}</td></tr>`; }
      document.getElementById('grandTotalFee').innerText = total.toLocaleString('id-ID');
    }

    function loadPiutang() {
      let dataP = getLocalData().filter(d => (parseFloat(d.sisa) || 0) > 0);
      let tb = document.getElementById('tabelPiutangBody'); 
      tb.innerHTML = '';
      let totalPiutang = 0; // Kanggo ngitung total

      if(dataP.length === 0) { 
        tb.innerHTML = '<tr><td colspan="7" class="text-success fw-bold text-center">Hebat! Tidak ada piutang. Semua lunas.</td></tr>'; 
        document.getElementById('grandTotalPiutang').innerText = "0";
        return; 
      }

      dataP.forEach(i => { 
        totalPiutang += parseFloat(i.sisa) || 0; // Ditambahkeun
        tb.innerHTML += `<tr><td class="fw-bold">${i.namaPembeli || '-'}</td><td>${i.namaProduk || '-'}</td><td>${i.brand || '-'}</td><td>${i.series || '-'}</td><td>${i.jenisOrder || '-'}</td><td>${i.ukuran || '-'}</td><td class="text-danger fw-bold">${i.sisa.toLocaleString('id-ID')}</td></tr>`; 
      });

      // Simpen hasilna kana baris Total
      document.getElementById('grandTotalPiutang').innerText = totalPiutang.toLocaleString('id-ID');
    }

    let deferredPrompt; const btnInstall = document.getElementById('btnInstall');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; btnInstall.style.display = 'inline-block'; });
    btnInstall.addEventListener('click', async () => { if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') { btnInstall.style.display = 'none'; } deferredPrompt = null; } });

    window.onload = loadDropdowns;
  </script>
</body>
</html>